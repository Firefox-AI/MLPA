name: Build and Push Docker Image to Google Artifact Registry

on:
  push:
    branches:
      - main
    tags:
      - "v**"

env:
  GCP_PROJECT_ID: moz-fx-llm-proxy-prod-b0b8
  GAR_REPOSITORY: llm-proxy-prod
  GAR_NAME: mlpa
  GAR_LOCATION: us
  GCPV2_WORKLOAD_IDENTITY_POOL_PROJECT_NUMBER: 324168772199
  GCPV2_GITHUB_WORKLOAD_IDENTITY_PROVIDER: projects/324168772199/locations/global/workloadIdentityPools/github-actions/providers/github-actions

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: build
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-tags: true

      - name: Authenticate to Google Cloud
        id: gcp-auth
        uses: google-github-actions/auth@v2
        with:
          token_format: "access_token"
          service_account: artifact-writer@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com
          workload_identity_provider: ${{ env.GCPV2_GITHUB_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Login to Google Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GAR_LOCATION }}-docker.pkg.dev
          username: oauth2accesstoken
          password: ${{ steps.gcp-auth.outputs.access_token }}

      - name: Build and Tag Container Image
        run: |
          IMAGE_REPO=${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.GAR_NAME }}
          SHA_TAG=$IMAGE_REPO:${{ github.sha }}

          docker build -t $SHA_TAG .
          docker tag $SHA_TAG $IMAGE_REPO:latest
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            docker tag $SHA_TAG $IMAGE_REPO:${{ github.ref_name }}
          fi

      - name: Push Container Image to GAR
        run: |
          IMAGE_REPO=${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.GAR_NAME }}

          docker push $IMAGE_REPO:${{ github.sha }}
          docker push $IMAGE_REPO:latest
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            docker push $IMAGE_REPO:${{ github.ref_name }}
          fi
